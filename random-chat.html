<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>랜덤 채팅 전용 화면</title>
    <link rel="icon" type="image/png" href="/favicon.png" sizes="96x96" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <style>
      :root {
        font-family: 'Pretendard', 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        color: #0f172a;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        background: radial-gradient(circle at 10% 20%, rgba(3, 199, 90, 0.08) 0, transparent 35%),
          radial-gradient(circle at 90% 10%, rgba(14, 165, 233, 0.12) 0, transparent 35%),
          linear-gradient(180deg, #f7faff 0%, #f6fff7 100%);
      }

      .top-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        background: rgba(255, 255, 255, 0.9);
        border-bottom: 1px solid #e5e7eb;
        backdrop-filter: blur(10px);
        position: sticky;
        top: 0;
        z-index: 10;
      }

      .logo {
        font-weight: 800;
        font-size: 1.1rem;
        color: #03c75a;
        text-decoration: none;
        letter-spacing: -0.01em;
      }

      .home-link {
        color: #0f172a;
        text-decoration: none;
        font-size: 0.95rem;
        border: 1px solid #d1d5db;
        padding: 6px 12px;
        border-radius: 999px;
        background: #fff;
        box-shadow: 0 10px 24px rgba(15, 23, 42, 0.06);
      }

      .container {
        max-width: 1040px;
        margin: 0 auto;
        padding: 32px 20px 48px;
      }

      header {
        margin-bottom: 24px;
      }

      h1 {
        margin: 0 0 12px;
        font-size: clamp(1.9rem, 3vw, 2.5rem);
        letter-spacing: -0.02em;
      }

      p {
        margin: 0;
        color: #4b5563;
      }

      .panel {
        background: #fff;
        border-radius: 18px;
        border: 1px solid #e5e7eb;
        padding: 24px;
        box-shadow: 0 12px 32px rgba(15, 23, 42, 0.08);
        margin-bottom: 20px;
      }

      .hero {
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding: 8px 0 4px;
      }

      .hero__eyebrow {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 999px;
        background: rgba(3, 199, 90, 0.12);
        color: #0b8a48;
        font-weight: 700;
        font-size: 0.9rem;
        width: fit-content;
      }

      .hero__title {
        margin: 0;
        font-size: clamp(2rem, 3vw, 2.5rem);
        letter-spacing: -0.02em;
      }

      .hero__actions {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
      }

      .chip {
        display: inline-flex;
        align-items: center;
        padding: 8px 12px;
        border-radius: 999px;
        border: 1px solid #e5e7eb;
        background: #fff;
        color: #0f172a;
        font-weight: 600;
        gap: 6px;
      }

      .panel-title {
        margin: 0 0 6px;
        font-size: 1.1rem;
      }

      .panel-sub {
        margin: 0;
        color: #475569;
      }

      .intro-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 16px;
      }

      .intro-card {
        border: 1px solid #e5e7eb;
        border-radius: 16px;
        padding: 16px;
        background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
      }

      .step-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .step-list li {
        display: flex;
        gap: 12px;
        align-items: center;
        background: #f8fafc;
        border: 1px solid #e5e7eb;
        border-radius: 14px;
        padding: 12px;
      }

      .step-index {
        width: 36px;
        height: 36px;
        border-radius: 10px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: rgba(3, 199, 90, 0.15);
        color: #0b8a48;
        font-weight: 700;
      }

      .status-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 16px;
        margin-top: 16px;
      }

      .status-card {
        border: 1px solid #e5e7eb;
        border-radius: 14px;
        padding: 16px;
        background: #f9fafb;
      }

      .status-card span {
        display: block;
        font-size: 0.85rem;
        text-transform: uppercase;
        color: #6b7280;
        margin-bottom: 4px;
      }

      .status-card strong {
        font-size: 1.3rem;
      }

      .controls {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 20px;
        padding: 10px;
        border: 1px solid #e5e7eb;
        border-radius: 14px;
        background: #f8fafc;
      }

      button {
        border-radius: 999px;
        border: 1px solid transparent;
        padding: 10px 20px;
        font-size: 0.95rem;
        cursor: pointer;
        transition: background 0.2s ease, color 0.2s ease, border-color 0.2s ease;
      }

      .btn-primary {
        background: #03c75a;
        color: #fff;
        border-color: #03c75a;
      }

      .btn-secondary {
        background: #fff;
        border-color: #d1d5db;
        color: #0f172a;
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .alert {
        border-radius: 12px;
        padding: 14px 16px;
        margin-bottom: 16px;
      }

      .alert-success {
        background: #ecfdf5;
        border: 1px solid #a7f3d0;
        color: #047857;
      }

      .alert-warning {
        background: #fffbeb;
        border: 1px solid #fde68a;
        color: #92400e;
      }

      .alert-danger {
        background: #fef2f2;
        border: 1px solid #fecaca;
        color: #b91c1c;
      }

      .stream {
        max-height: 360px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-top: 12px;
        padding: 8px;
        border: 1px solid #e5e7eb;
        border-radius: 14px;
        background: #ffffff;
      }

      .message {
        border: 1px solid #e5e7eb;
        border-radius: 16px;
        padding: 12px 14px;
        background: #fff;
      }

      .message strong {
        display: block;
        margin-bottom: 4px;
      }

      .message small {
        color: #6b7280;
      }

      .message.me {
        border-color: rgba(3, 199, 90, 0.35);
        background: rgba(3, 199, 90, 0.1);
        align-self: flex-end;
      }

      textarea {
        width: 100%;
        min-height: 110px;
        border-radius: 12px;
        border: 1px solid #d1d5db;
        padding: 12px 14px;
        font-size: 1rem;
        resize: vertical;
        background: #fff;
        color: #0f172a;
      }

      textarea:focus {
        outline: none;
        border-color: #03c75a;
        box-shadow: 0 0 0 2px rgba(3, 199, 90, 0.15);
      }

      .form-actions {
        display: flex;
        justify-content: flex-end;
        margin-top: 12px;
      }

      .placeholder {
        border: 1px dashed #d1d5db;
        border-radius: 14px;
        text-align: center;
        padding: 32px;
        color: #6b7280;
        margin-top: 12px;
      }

      .hi-sidebar {
        position: fixed;
        top: 50%;
        right: 1.5rem;
        transform: translateY(-50%);
        width: 260px;
        background: linear-gradient(180deg, #ffffff 0%, #f8fbff 100%);
        border-radius: 20px;
        border: 1px solid #dce4f2;
        padding: 1.75rem 1.5rem;
        z-index: 999;
        display: flex;
        flex-direction: column;
        gap: 0.85rem;
        box-shadow: 0 25px 60px rgba(15, 23, 42, 0.15);
      }

      .hi-sidebar__badge {
        display: inline-flex;
        align-items: center;
        font-size: 0.72rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        font-weight: 600;
        color: #0ea5e9;
        background: rgba(14, 165, 233, 0.12);
        padding: 0.25rem 0.7rem;
        border-radius: 999px;
      }

      .hi-sidebar__title {
        margin: 0;
        font-size: 1.3rem;
        color: #0f172a;
      }

      .hi-sidebar__text {
        margin: 0;
        color: #4b5563;
        font-size: 0.95rem;
        line-height: 1.5;
      }

      .hi-sidebar__cta {
        align-self: flex-start;
        border-radius: 999px;
        padding-inline: 1.4rem;
        text-decoration: none;
        box-shadow: 0 10px 20px rgba(3, 199, 90, 0.25);
      }

      .hi-sidebar__toggle {
        align-self: flex-start;
        border-radius: 999px;
        margin-bottom: 0.5rem;
      }

      .hi-sidebar--closed {
        transform: translateY(-50%) translateX(120%);
      }

      .hi-sidebar--closed .hi-sidebar__content {
        display: none;
      }

      @media (max-width: 992px) {
        .hi-sidebar {
          width: auto;
          min-width: 220px;
          bottom: 1.5rem;
          top: auto;
          right: 1rem;
          transform: none;
          padding: 1.1rem 1.25rem;
        }

        .hi-sidebar--closed {
          transform: translateX(calc(100% + 1.5rem));
        }
      }
    </style>
  </head>
  <body>
    <div class="top-bar">
      <a class="logo" href="/">CoCo-Chat</a>
      <a class="home-link" href="/">홈으로 돌아가기</a>
    </div>
    <div class="container">
      <header class="hero">
        <div class="hero__eyebrow">1:1 랜덤 매칭</div>
        <h1 class="hero__title">버튼 한 번으로 새로운 사람과 대화하세요</h1>
        <p>대기열 합류 → 매칭 → 대화까지 한 화면에서 이어집니다. 대화 내용을 남기지 않고 바로 즐겨보세요.</p>
        <div class="hero__actions">
          <span class="chip">대기열 자동 매칭</span>
          <span class="chip">전화번호 패턴 자동 차단</span>
          <span class="chip">모바일 최적화</span>
        </div>
      </header>

      <section class="panel intro-panel">
        <h2 class="panel-title">어떻게 이용하나요?</h2>
        <p class="panel-sub">3단계만 거치면 바로 대화할 수 있습니다.</p>
        <div class="intro-grid">
          <div class="intro-card">
            <ul class="step-list">
              <li>
                <span class="step-index">1</span>
                <div>
                  <strong>대기열 진입</strong>
                  <p>“대기열 진입” 버튼을 눌러 매칭을 준비합니다.</p>
                </div>
              </li>
              <li>
                <span class="step-index">2</span>
                <div>
                  <strong>채팅하기</strong>
                  <p>“채팅하기” 버튼으로 바로 상대와 연결됩니다.</p>
                </div>
              </li>
              <li>
                <span class="step-index">3</span>
                <div>
                  <strong>대화 주고받기</strong>
                  <p>연락처 형식(010-0000-0000)은 자동으로 막혀 안전합니다.</p>
                </div>
              </li>
            </ul>
          </div>
          <div class="intro-card">
            <h3 class="panel-title">안심 기능</h3>
            <p class="panel-sub">신고 없이도 안전하게 즐길 수 있도록 기본 보호 장치를 넣었습니다.</p>
            <ul class="step-list">
              <li>
                <span class="step-index">OK</span>
                <div>
                  <strong>자동 재연결</strong>
                  <p>연결이 끊겨도 다시 시도하니 대화를 이어가기 쉽습니다.</p>
                </div>
              </li>
              <li>
                <span class="step-index">OK</span>
                <div>
                  <strong>매칭 현황 표시</strong>
                  <p>현재 상태와 참여 인원을 실시간으로 확인합니다.</p>
                </div>
              </li>
            </ul>
          </div>
        </div>
      </section>

      <section class="panel" id="state-panel">
        <h2 class="panel-title">실시간 현황</h2>
        <p class="panel-sub">대기열, 매칭 상태, 메시지 전송을 이곳에서 모두 제어하세요.</p>
        <div id="state-alert"></div>
        <div class="status-grid">
          <div class="status-card">
            <span>전체 참여자</span>
            <strong id="participant-total">0명</strong>
          </div>
          <div class="status-card">
            <span>현재 상태</span>
            <strong id="current-status">대기열에 합류하지 않았습니다.</strong>
          </div>
        </div>
        <div class="controls">
          <button class="btn-primary" id="join-btn">대기열 진입</button>
          <button class="btn-secondary" id="leave-btn" disabled>대기열 나가기</button>
          <button class="btn-secondary" id="match-btn" disabled>채팅하기</button>
          <button class="btn-secondary" id="refresh-btn">상태 새로고침</button>
        </div>
        <p class="panel-sub" style="margin-top: 10px">대기열에 들어간 뒤 “채팅하기”를 누르면 바로 매칭됩니다.</p>
      </section>

      <section class="panel" id="chat-panel">
        <h2 class="panel-title">대화 영역</h2>
        <p class="panel-sub">매칭된 상대와 주고받은 메시지는 여기에서 확인합니다.</p>
        <div id="chat-alert"></div>
        <div id="match-notice" class="alert alert-success" hidden>상대방과 연결되었습니다.</div>
        <div class="stream" id="message-stream"></div>
        <div class="placeholder" id="placeholder-text">
          아직 매칭되지 않았습니다. 대기열에 진입한 뒤 채팅하기를 눌러 상대방과 연결하세요.
        </div>
        <form id="message-form">
          <textarea
            id="message-input"
            placeholder="메시지를 입력하세요. 010-0000-0000 형식의 연락처는 전송할 수 없습니다."
            maxlength="500"
            disabled
          ></textarea>
          <div class="form-actions">
            <button class="btn-primary" type="submit" id="send-btn" disabled>메시지 전송</button>
          </div>
        </form>
      </section>
    </div>

    <aside class="hi-sidebar" data-sidebar>
      <button class="hi-sidebar__toggle btn btn-outline-secondary btn-sm" type="button" data-sidebar-toggle hidden>
        닫기
      </button>
      <div class="hi-sidebar__content">
        <div class="hi-sidebar__badge">제작자</div>
        <h3 class="hi-sidebar__title">"HI" 인사하기</h3>
        <p class="hi-sidebar__text">서비스 제작자(py9245)에게 궁금한 점이나 응원 메시지를 바로 남겨보세요.</p>
        <a
          class="hi-sidebar__cta btn btn-success btn-sm"
          href="https://meeting.ssafy.com/s14public/messages/@py9245"
          target="_blank"
          rel="noopener"
        >
          메세지 보내기
        </a>
      </div>
    </aside>

    <script>
      const TOKEN_KEY = 'codex_auth_token'
      const STATE_LIMIT = 60
      const PHONE_PATTERN = /010-\d{4}-\d{4}/

      const determineBackendOrigin = () => {
        const storedBase = (() => {
          try {
            return localStorage.getItem('API_BASE_URL') || null
          } catch {
            return null
          }
        })()
        const runtimeBase = window.API_BASE_URL || storedBase || null
        if (runtimeBase) {
          try {
            return new URL(runtimeBase, window.location.origin).origin
          } catch {
            // fall through
          }
        }
        const host = (window.location.hostname || '').toLowerCase()
        if (host.includes('github.io') || host.includes('githubusercontent.com')) {
          return 'https://3-37-130-181.nip.io'
        }
        return window.location.origin || 'https://3-37-130-181.nip.io'
      }
      const BACKEND_ORIGIN = determineBackendOrigin().replace(/\/$/, '')

      ;(() => {
        const participantTotalEl = document.getElementById('participant-total')
        const currentStatusEl = document.getElementById('current-status')
        const stateAlertEl = document.getElementById('state-alert')
        const chatAlertEl = document.getElementById('chat-alert')
        const matchNoticeEl = document.getElementById('match-notice')
        const messageStreamEl = document.getElementById('message-stream')
        const placeholderEl = document.getElementById('placeholder-text')
        const messageInputEl = document.getElementById('message-input')
        const sendBtnEl = document.getElementById('send-btn')
        const messageFormEl = document.getElementById('message-form')
        const joinBtn = document.getElementById('join-btn')
        const leaveBtn = document.getElementById('leave-btn')
        const matchBtn = document.getElementById('match-btn')
        const refreshBtn = document.getElementById('refresh-btn')

        let token = null
        let socket = null
        let reconnectTimer = null
        let intentionalClose = false
        let currentSessionId = null
        let partnerAlias = '상대방'
        const PLACEHOLDER_WAITING =
          '아직 매칭되지 않았습니다. 대기열에 진입한 뒤 채팅하기를 눌러 상대방과 연결하세요.'
        const PLACEHOLDER_CONNECTED = '상대방과 연결되었습니다. 첫 메시지를 보내보세요.'

        const readToken = () => {
          try {
            token = localStorage.getItem(TOKEN_KEY)
          } catch {
            token = null
          }
        }

        const setAlert = (target, message, tone = 'danger') => {
          if (!target) return
          if (!message) {
            target.innerHTML = ''
            return
          }
          const className =
            tone === 'success'
              ? 'alert alert-success'
              : tone === 'warning'
                ? 'alert alert-warning'
                : 'alert alert-danger'
          target.innerHTML = `<div class="${className}">${message}</div>`
        }

        const buildWsUrl = () => {
          const protocol = BACKEND_ORIGIN.startsWith('https') ? 'wss' : 'ws'
          const host = BACKEND_ORIGIN.replace(/^https?:\/\//, '')
          return `${protocol}://${host}/ws/random-chat/?token=${encodeURIComponent(token)}`
        }

        const connectSocket = () => {
          if (!token) {
            setAlert(stateAlertEl, '로그인 후 이용할 수 있습니다.', 'warning')
            return
          }
          if (socket && socket.readyState === WebSocket.OPEN) return
          socket = new WebSocket(buildWsUrl())
          socket.addEventListener('open', () => {
            setAlert(stateAlertEl, '')
            sendAction('fetch_state')
          })
          socket.addEventListener('message', handleSocketMessage)
          socket.addEventListener('close', (event) => {
            if (intentionalClose) {
              intentionalClose = false
              return
            }
            if (event.code === 4401) {
              setAlert(stateAlertEl, '인증에 실패했습니다. 다시 로그인해 주세요.', 'danger')
              return
            }
            setAlert(stateAlertEl, '실시간 연결이 종료되었습니다. 재연결을 시도합니다.', 'warning')
            if (reconnectTimer) clearTimeout(reconnectTimer)
            reconnectTimer = setTimeout(connectSocket, 3000)
          })
          socket.addEventListener('error', () => {
            socket.close()
          })
        }

        const disconnectSocket = () => {
          if (socket) {
            intentionalClose = true
            socket.close()
            socket = null
          }
        }

        const sendAction = (action, payload = {}) => {
          if (!socket || socket.readyState !== WebSocket.OPEN) {
            connectSocket()
            setAlert(stateAlertEl, '실시간 연결을 준비 중입니다. 잠시 후 다시 시도해 주세요.', 'warning')
            return false
          }
          socket.send(JSON.stringify({ action, ...payload }))
          return true
        }

        const handleSocketMessage = (event) => {
          try {
            const data = JSON.parse(event.data)
            switch (data.event) {
              case 'state':
                updateUI(data.payload)
                setAlert(chatAlertEl, '')
                break
              case 'messages': {
                const placeholderMessage = currentSessionId
                  ? PLACEHOLDER_CONNECTED
                  : PLACEHOLDER_WAITING
                renderMessages(data.messages, partnerAlias, placeholderMessage)
                break
              }
              case 'message':
                appendMessage(data.message, partnerAlias)
                break
              case 'info':
                setAlert(stateAlertEl, data.detail, 'success')
                break
              case 'error':
                setAlert(stateAlertEl, data.detail, 'danger')
                break
              default:
                console.warn('Unhandled event', data)
            }
          } catch (error) {
            console.error('메시지를 파싱할 수 없습니다.', error)
          }
        }

        const formatTime = (value) =>
          new Intl.DateTimeFormat('ko-KR', { timeStyle: 'short' }).format(new Date(value))

        const shouldStickToBottom = () =>
          Math.abs(messageStreamEl.scrollHeight - (messageStreamEl.scrollTop + messageStreamEl.clientHeight)) < 40

        const renderMessages = (messages = [], alias = '상대방', placeholderMessage = null) => {
          const stick = shouldStickToBottom()
          messageStreamEl.innerHTML = ''
          if (!messages.length) {
            if (placeholderEl) {
              if (placeholderMessage) {
                placeholderEl.textContent = placeholderMessage
              }
              placeholderEl.hidden = false
            }
            return
          }
          if (placeholderEl) {
            placeholderEl.hidden = true
          }
          messages.forEach((msg) => appendMessage(msg, alias, false))
          if (stick) {
            messageStreamEl.scrollTop = messageStreamEl.scrollHeight
          }
        }

        const appendMessage = (message, alias = '상대방', autoScroll = true) => {
          if (!message) return
          if (placeholderEl) {
            placeholderEl.hidden = true
          }
          const stick = autoScroll ? shouldStickToBottom() : false
          const wrapper = document.createElement('article')
          wrapper.className = 'message' + (message.from_self ? ' me' : '')
          const author = message.from_self ? '나' : alias
          wrapper.innerHTML = `<strong>${author}</strong><p>${message.content}</p><small>${formatTime(message.created_at)}</small>`
          messageStreamEl.appendChild(wrapper)
          if (stick || autoScroll) {
            messageStreamEl.scrollTop = messageStreamEl.scrollHeight
          }
        }

        const updateUI = (payload) => {
          const {
            queue_size = 0,
            active_sessions = 0,
            in_queue = false,
            session = null,
            messages = [],
          } = payload || {}

          const participantTotal = Math.max(queue_size + active_sessions * 2, 0)
          participantTotalEl.textContent = `${participantTotal}명`

          if (session) {
            partnerAlias = session.partner_alias || '상대방'
            currentStatusEl.textContent = `${partnerAlias}과 연결되었습니다.`
            messageInputEl.disabled = false
            sendBtnEl.disabled = false
            const isNewSession = session.id !== currentSessionId
            currentSessionId = session.id
            matchNoticeEl.hidden = !isNewSession
            if (isNewSession) {
              setAlert(chatAlertEl, `"${partnerAlias}"님과 매칭되었습니다.`, 'success')
            }
          } else if (in_queue) {
            currentStatusEl.textContent = '대기열에서 상대를 기다리는 중'
            messageInputEl.disabled = true
            sendBtnEl.disabled = true
            matchNoticeEl.hidden = true
            messageInputEl.value = ''
            currentSessionId = null
          } else {
            currentStatusEl.textContent = '대기열에 합류하지 않았습니다.'
            messageInputEl.disabled = true
            sendBtnEl.disabled = true
            matchNoticeEl.hidden = true
            messageInputEl.value = ''
            currentSessionId = null
            partnerAlias = '상대방'
          }

          joinBtn.disabled = Boolean(in_queue)
          leaveBtn.disabled = !in_queue
          matchBtn.disabled = !in_queue

          if (session && messages.length) {
            renderMessages(messages, partnerAlias)
          } else if (session) {
            renderMessages([], partnerAlias, PLACEHOLDER_CONNECTED)
          } else {
            renderMessages([], partnerAlias, PLACEHOLDER_WAITING)
          }
        }

        joinBtn.addEventListener('click', () => {
          if (!token) {
            setAlert(stateAlertEl, '로그인 후 이용할 수 있습니다.', 'warning')
            return
          }
          sendAction('join_queue')
        })

        leaveBtn.addEventListener('click', () => {
          sendAction('leave_queue')
        })

        matchBtn.addEventListener('click', () => {
          sendAction('request_match')
        })

        refreshBtn.addEventListener('click', () => {
          sendAction('fetch_state')
        })

        messageInputEl.addEventListener('keydown', (event) => {
          if (event.key === 'Enter' && !event.shiftKey && !event.isComposing) {
            event.preventDefault()
            sendBtnEl.click()
          }
        })

        messageFormEl.addEventListener('submit', (event) => {
          event.preventDefault()
          if (!currentSessionId) {
            setAlert(chatAlertEl, '매칭이 완료된 후 메시지를 보낼 수 있습니다.', 'warning')
            return
          }
          const content = messageInputEl.value.trim()
          if (!content) {
            setAlert(chatAlertEl, '메시지를 입력해 주세요.', 'warning')
            return
          }
          if (PHONE_PATTERN.test(content)) {
            setAlert(chatAlertEl, '전화번호 형식(010-0000-0000)은 전송할 수 없습니다.')
            return
          }
          if (sendAction('send_message', { content })) {
            messageInputEl.value = ''
            setAlert(chatAlertEl, '')
          }
        })

        window.addEventListener('storage', (event) => {
          if (event.key !== TOKEN_KEY) return
          const previousToken = token
          readToken()
          if (!token) {
            disconnectSocket()
            setAlert(stateAlertEl, '로그인 후 이용할 수 있습니다.', 'warning')
            updateUI({ in_queue: false, messages: [] })
            return
          }
          if (token !== previousToken) {
            disconnectSocket()
            connectSocket()
          }
        })

        readToken()
        if (token) {
          connectSocket()
        } else {
          setAlert(stateAlertEl, '로그인 후 이용할 수 있습니다.', 'warning')
        }
      })()

      ;(() => {
        const sidebar = document.querySelector('[data-sidebar]')
        if (!sidebar) return
        const toggleButton = sidebar.querySelector('[data-sidebar-toggle]')
        const content = sidebar.querySelector('.hi-sidebar__content')
        const mobileQuery = window.matchMedia('(max-width: 992px)')
        let isOpen = true

        const syncState = () => {
          const isMobile = mobileQuery.matches
          if (!isMobile) {
            isOpen = true
          }
          if (toggleButton) {
            toggleButton.hidden = !isMobile
            toggleButton.textContent = isOpen ? '닫기' : '"HI" 인사하기'
          }
          if (content) {
            const shouldHideContent = isMobile && !isOpen
            content.style.display = shouldHideContent ? 'none' : ''
            content.setAttribute('aria-hidden', shouldHideContent ? 'true' : 'false')
          }
          sidebar.classList.toggle('hi-sidebar--closed', isMobile && !isOpen)
        }

        if (toggleButton) {
          toggleButton.addEventListener('click', () => {
            if (!mobileQuery.matches) {
              return
            }
            isOpen = !isOpen
            syncState()
          })
        }

        mobileQuery.addEventListener('change', syncState)
        window.addEventListener('resize', syncState)
        syncState()
      })()
    </script>
  </body>
</html>
