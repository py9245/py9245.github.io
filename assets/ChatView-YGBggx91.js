import{K as I,u as ae,r as c,D as N,w as q,o as oe,a as le,c as o,b as e,t as d,h as A,F,j as B,k as D,l as v,v as y,G as K,d as ne,e as ie,f as re,g as ce,i as $,S as de,T as ue,U as me,z as l,n as H,V as J,W as ve,X as pe}from"./index-DnedYGLe.js";const _e={class:"panel"},ye={class:"row g-4"},fe={class:"col-12 col-lg-4"},he={class:"card border-0 mb-4"},be={class:"card-body"},we={key:0,class:"alert alert-info"},ge={key:1,class:"alert alert-danger"},ke={key:2,class:"list-group list-group-flush"},xe={key:0,class:"list-group-item bg-transparent text-white-50"},Ce={class:"mb-0 fw-semibold"},Re={class:"text-white-50"},Ve=["disabled","onClick"],Se={key:0},Ae={key:1},Le={key:2},Te={key:3},Ue={key:4},Me={class:"card border-0 mb-4"},je={class:"card-body"},Ie={class:"col-12"},Ne={class:"col-12"},De={class:"col-12 form-check form-switch"},Ee={key:0,class:"col-12"},Pe={class:"col-12"},qe=["disabled"],Fe={key:0},Be={key:1},Ke={class:"card border-0"},$e={class:"card-body"},He={class:"col-12"},Je={class:"col-12"},Oe={class:"col-12"},ze=["disabled"],Ge={key:0},We={key:1},Xe={class:"col-12 col-lg-8"},Ye={class:"card border-0 h-100"},Qe={class:"card-body d-flex flex-column gap-3 h-100"},Ze={class:"d-flex justify-content-between align-items-center"},et={class:"text-light mb-1"},tt={class:"text-white-50 mb-0"},st={class:"d-flex gap-2"},at=["disabled"],ot={key:0},lt={key:1},nt={key:0,class:"alert alert-info"},it={key:1,class:"alert alert-secondary"},rt={key:2,class:"chat-messages list-group list-group-flush"},ct={class:"d-flex justify-content-between"},dt={class:"mt-1"},ut={key:3,class:"alert alert-warning"},mt={key:4,class:"alert alert-danger"},vt={key:0,class:"form-check form-switch mb-3"},pt={class:"form-check-label text-white-50",for:"chatAnon"},_t={key:1,class:"text-white-50 small"},yt=["disabled"],ft={key:0},ht={key:1},bt={key:6,class:"alert alert-info mt-auto"},wt={key:7,class:"alert alert-warning mt-auto"},O=80,gt=500,Rt={__name:"ChatView",setup(kt){const{profile:f,ensureProfileLoaded:z}=ae(),L=I(()=>!!f.value?.user?.is_staff),T=c([]),U=c(!1),w=c(""),n=c(null),g=c(null),k=c(!1),_=c([]),u=N({content:"",is_anonymous:!0}),M=c(!1),x=c(!1),i=c(""),r=N({name:"",capacity:10,is_private:!1,password:""}),C=c(!1),m=N({name:"",password:""}),R=c(!1);let V=null;const G=I(()=>!L.value),W=s=>{if(!s)return"";const t=typeof s=="string"?new Date(s):s;return Number.isNaN(t.getTime())?"":new Intl.DateTimeFormat("ko-KR",{dateStyle:"short",timeStyle:"short"}).format(t)},X=I(()=>!!(f.value&&n.value&&u.content.trim())),h=async()=>{U.value=!0,w.value="";try{const s=await de();T.value=Array.isArray(s?.rooms)?s.rooms:[]}catch(s){console.error(s),w.value="채팅방 목록을 불러오지 못했습니다."}finally{U.value=!1}},S=s=>{n.value=s||null},E=async({roomId:s=n.value?.id,silent:t=!1}={})=>{if(s){t||(M.value=!0,i.value="");try{const p=await pe(s,{limit:O});_.value=Array.isArray(p?.messages)?p.messages:[]}catch(p){console.error(p),i.value=p?.payload?.detail||"채팅 메시지를 불러오지 못했습니다."}finally{t||(M.value=!1)}}},j=()=>{V&&(clearInterval(V),V=null)},Y=()=>{j(),n.value&&(V=window.setInterval(()=>{E({roomId:n.value?.id,silent:!0})},gt))};q(L,s=>{s&&(u.is_anonymous=!1)},{immediate:!0}),q(n,s=>{j(),_.value=[],s&&(E({roomId:s.id}),Y())});const b=()=>f.value?!0:(i.value="로그인 후 이용해 주세요.",!1),Q=async s=>{if(b()){g.value=s.id,i.value="";try{const t=await J({name:s.name});S(t?.room??null),s.is_private||await h()}catch(t){console.error(t),i.value=t?.payload?.detail||"채팅방에 입장하지 못했습니다."}finally{g.value=null}}},Z=async()=>{if(b()){if(!m.name.trim()){i.value="비공개 채팅방 이름을 입력해주세요.";return}if(!m.password.trim()){i.value="비공개 채팅방 비밀번호를 입력해주세요.";return}R.value=!0,i.value="";try{const s=await J({name:m.name.trim(),password:m.password});S(s?.room??null),m.name="",m.password=""}catch(s){console.error(s),i.value=s?.payload?.detail||"비공개 채팅방에 입장하지 못했습니다."}finally{R.value=!1}}},ee=async()=>{if(b()){C.value=!0,i.value="";try{const s=await ve({name:r.name.trim(),capacity:Number(r.capacity),is_private:r.is_private,password:r.is_private?r.password:""});if(!s?.room)throw new Error("채팅방 응답이 없습니다.");S(s.room),s.room.is_private||await h(),r.name="",r.password="",r.capacity=10,r.is_private=!1}catch(s){console.error(s),i.value=s?.payload?.detail||(s?.payload&&typeof s.payload=="object"?Object.values(s.payload).flat().join(" "):"채팅방을 생성하지 못했습니다.")}finally{C.value=!1}}},te=async()=>{if(!(!n.value||!b())){k.value=!0,i.value="";try{await ue(n.value.id),S(null),await h()}catch(s){console.error(s),i.value=s?.payload?.detail||"채팅방에서 나가지 못했습니다."}finally{k.value=!1}}},P=async()=>{if(!b())return;if(!n.value){i.value="먼저 채팅방에 입장해 주세요.";return}const s=u.content.trim();if(!s){i.value="메시지를 입력해 주세요.";return}x.value=!0;try{const t=await me(n.value.id,{content:s,is_anonymous:G.value?u.is_anonymous:!1});_.value=[..._.value,t].slice(-O),u.content="",i.value=""}catch(t){console.error(t),i.value=t?.payload?.detail||"메시지를 전송하지 못했습니다."}finally{x.value=!1}},se=s=>{s.key!=="Enter"||s.shiftKey||s.isComposing||(s.preventDefault(),P())};return oe(async()=>{await z(),await h()}),le(()=>{j()}),(s,t)=>{const p=ce("router-link");return l(),o("section",_e,[e("div",ye,[e("div",fe,[e("div",he,[e("div",be,[t[8]||(t[8]=e("h5",{class:"text-light mb-3"},"공개 채팅방",-1)),t[9]||(t[9]=e("p",{class:"text-white-50 small mb-3"},"목록에는 누구나 입장 가능한 공개형 채팅방만 표시됩니다.",-1)),U.value?(l(),o("div",we,"채팅방 목록을 불러오는 중...")):w.value?(l(),o("div",ge,d(w.value),1)):(l(),o("ul",ke,[T.value.length?A("",!0):(l(),o("li",xe," 아직 공개 채팅방이 없습니다. ")),(l(!0),o(F,null,B(T.value,a=>(l(),o("li",{key:a.id,class:"list-group-item d-flex justify-content-between align-items-center bg-transparent text-light"},[e("div",null,[e("p",Ce,d(a.name),1),e("small",Re,d(a.member_count)+"/"+d(a.capacity)+" · "+d(a.owner_username||"운영자"),1)]),e("button",{class:H(["btn btn-sm nav-hover",a.is_member?"btn-secondary":"btn-outline-light"]),disabled:g.value===a.id||a.member_count>=a.capacity||a.is_member&&n.value&&n.value.id===a.id,type:"button",onClick:xt=>Q(a)},[g.value===a.id?(l(),o("span",Se,"입장 중...")):a.is_member&&n.value&&n.value.id===a.id?(l(),o("span",Ae,"이용 중")):a.is_member?(l(),o("span",Le,"입장 완료")):a.member_count>=a.capacity?(l(),o("span",Te,"정원 초과")):(l(),o("span",Ue,"입장"))],10,Ve)]))),128))])),e("button",{class:"btn btn-outline-info nav-hover mt-3 w-100",type:"button",onClick:h},"새로 고침")])]),e("div",Me,[e("div",je,[t[15]||(t[15]=e("h5",{class:"text-light mb-3"},"채팅방 생성",-1)),e("form",{class:"row g-3",autocomplete:"off",onSubmit:D(ee,["prevent"])},[e("div",Ie,[t[10]||(t[10]=e("label",{class:"form-label text-white-50"},"채팅방 이름",-1)),v(e("input",{"onUpdate:modelValue":t[0]||(t[0]=a=>r.name=a),class:"form-control",maxlength:"50",required:""},null,512),[[y,r.name]])]),e("div",Ne,[t[11]||(t[11]=e("label",{class:"form-label text-white-50"},"정원 (2~200명)",-1)),v(e("input",{"onUpdate:modelValue":t[1]||(t[1]=a=>r.capacity=a),class:"form-control",min:"2",max:"200",type:"number",required:""},null,512),[[y,r.capacity,void 0,{number:!0}]])]),e("div",De,[v(e("input",{id:"createPrivate","onUpdate:modelValue":t[2]||(t[2]=a=>r.is_private=a),class:"form-check-input",type:"checkbox"},null,512),[[K,r.is_private]]),t[12]||(t[12]=e("label",{class:"form-check-label text-white-50",for:"createPrivate"},"비공개 채팅방",-1))]),r.is_private?(l(),o("div",Ee,[t[13]||(t[13]=e("label",{class:"form-label text-white-50"},"비밀번호",-1)),v(e("input",{"onUpdate:modelValue":t[3]||(t[3]=a=>r.password=a),class:"form-control",type:"password",minlength:"4",required:""},null,512),[[y,r.password]]),t[14]||(t[14]=e("small",{class:"text-white-50"},"비공개 채팅방은 목록에 표시되지 않으며 비밀번호로만 입장합니다.",-1))])):A("",!0),e("div",Pe,[e("button",{class:"btn btn-primary nav-hover w-100",disabled:C.value,type:"submit"},[C.value?(l(),o("span",Fe,"생성 중...")):(l(),o("span",Be,"채팅방 생성"))],8,qe)])],32)])]),e("div",Ke,[e("div",$e,[t[18]||(t[18]=e("h5",{class:"text-light mb-3"},"비공개 채팅방 입장",-1)),e("form",{class:"row g-3",autocomplete:"off",onSubmit:D(Z,["prevent"])},[e("div",He,[t[16]||(t[16]=e("label",{class:"form-label text-white-50"},"채팅방 이름",-1)),v(e("input",{"onUpdate:modelValue":t[4]||(t[4]=a=>m.name=a),class:"form-control",placeholder:"예) 프로젝트 A",required:""},null,512),[[y,m.name]])]),e("div",Je,[t[17]||(t[17]=e("label",{class:"form-label text-white-50"},"비밀번호",-1)),v(e("input",{"onUpdate:modelValue":t[5]||(t[5]=a=>m.password=a),class:"form-control",type:"password",required:""},null,512),[[y,m.password]])]),e("div",Oe,[e("button",{class:"btn btn-outline-light nav-hover w-100",disabled:R.value,type:"submit"},[R.value?(l(),o("span",Ge,"입장 중...")):(l(),o("span",We,"입장하기"))],8,ze)])],32)])])]),e("div",Xe,[e("div",Ye,[e("div",Qe,[e("div",Ze,[e("div",null,[e("h5",et,d(n.value?n.value.name:"채팅방을 선택해 주세요"),1),e("p",tt,d(n.value?`정원 ${n.value.member_count}/${n.value.capacity} · ${n.value.is_private?"비공개":"공개"}`:"좌측에서 채팅방을 선택하거나 새로 만들 수 있습니다."),1)]),e("div",st,[ne(p,{class:"btn btn-outline-light btn-sm nav-hover",to:"/boards"},{default:ie(()=>[...t[19]||(t[19]=[re("게시판 보기",-1)])]),_:1}),n.value?(l(),o("button",{key:0,class:"btn btn-outline-danger btn-sm nav-hover",disabled:k.value,type:"button",onClick:te},[k.value?(l(),o("span",ot,"나가는 중...")):(l(),o("span",lt,"채팅방 나가기"))],8,at)):A("",!0)])]),M.value?(l(),o("div",nt,"채팅 메시지를 불러오는 중...")):n.value&&!_.value.length?(l(),o("div",it," 아직 대화가 없습니다. 첫 메시지를 남겨보세요! ")):n.value?(l(),o("div",rt,[(l(!0),o(F,null,B(_.value,a=>(l(),o("article",{key:a.id,class:"chat-message list-group-item"},[e("div",ct,[e("span",{class:H(["fw-semibold",{"text-warning":a.is_anonymous}])},d(a.display_name),3),e("small",null,d(W(a.created_at)),1)]),e("p",dt,d(a.content),1)]))),128))])):(l(),o("div",ut,"채팅방을 선택하거나 새로 만들어주세요.")),i.value?(l(),o("div",mt,d(i.value),1)):A("",!0),$(f)&&n.value?(l(),o("form",{key:5,class:"chat-form mt-auto",autocomplete:"off",onSubmit:D(P,["prevent"])},[L.value?(l(),o("p",_t,"관리자는 실명(아이디)으로만 메시지를 보낼 수 있습니다.")):(l(),o("div",vt,[v(e("input",{id:"chatAnon","onUpdate:modelValue":t[6]||(t[6]=a=>u.is_anonymous=a),class:"form-check-input",type:"checkbox"},null,512),[[K,u.is_anonymous]]),e("label",pt,d(u.is_anonymous?"익명으로 보내기":"아이디 공개"),1)])),v(e("textarea",{"onUpdate:modelValue":t[7]||(t[7]=a=>u.content=a),class:"form-control",name:"chat-content",placeholder:"지금 떠오르는 생각을 적어보세요 (최대 500자)",maxlength:"500",onKeydown:se},null,544),[[y,u.content]]),e("button",{class:"btn btn-primary nav-hover mt-3",disabled:x.value||!X.value,type:"submit"},[x.value?(l(),o("span",ft,"전송 중...")):(l(),o("span",ht,"메시지 전송"))],8,yt)],32)):$(f)?(l(),o("div",bt," 채팅방에 입장해야 메시지를 보낼 수 있습니다. ")):(l(),o("div",wt," 로그인한 사용자만 채팅에 참여할 수 있습니다. 계정 페이지에서 로그인해 주세요. "))])])])])])}}};export{Rt as default};
