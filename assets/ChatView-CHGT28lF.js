import{r as m,l as M,B as T,u as S,o as L,K as N,c as a,a as t,k as V,b as A,w as I,d as B,e as D,F,f as P,t as c,m as E,q as H,p,x as R,v as U,L as j,i as o,n as K,M as O}from"./index-JrWTJFiS.js";const q={class:"panel"},z={class:"d-flex justify-content-between align-items-center mb-3"},Y={key:0,class:"alert alert-info"},G={key:1,class:"alert alert-secondary"},J={key:2,class:"chat-messages list-group list-group-flush"},Q={class:"d-flex justify-content-between"},W={class:"mt-1"},X={key:3,class:"alert alert-danger mt-4"},Z={class:"form-check form-switch mb-3"},$={class:"form-check-label text-white-50",for:"chatAnon"},ee=["disabled"],te={key:0},se={key:1},ae={key:5,class:"alert alert-warning mt-4"},y=80,oe=500,re={__name:"ChatView",setup(ne){const{profile:f,ensureProfileLoaded:g}=S(),i=m([]),n=M({content:"",is_anonymous:!0}),_=m(!1),u=m(!1),r=m("");let d=null;const b=s=>{if(!s)return"";const e=typeof s=="string"?new Date(s):s;return Number.isNaN(e.getTime())?"":new Intl.DateTimeFormat("ko-KR",{dateStyle:"short",timeStyle:"short"}).format(e)},w=T(()=>!!(f.value&&n.content.trim())),h=async({silent:s=!1}={})=>{s||(_.value=!0,r.value="");try{const e=await j({limit:y});i.value=Array.isArray(e?.messages)?e.messages:[]}catch(e){console.error(e),r.value="채팅 메시지를 불러오지 못했습니다."}finally{s||(_.value=!1)}},v=()=>{d&&(clearInterval(d),d=null)},k=()=>{v(),d=window.setInterval(()=>{h({silent:!0})},oe)},x=async()=>{if(!f.value){r.value="로그인 후 이용해 주세요.";return}const s=n.content.trim();if(!s){r.value="메시지를 입력해 주세요.";return}u.value=!0;try{const e=await O({content:s,is_anonymous:n.is_anonymous});i.value=[...i.value,e].slice(-y),n.content="",r.value=""}catch(e){console.error(e),r.value=e?.payload?.detail||"메시지를 전송하지 못했습니다."}finally{u.value=!1}};return L(async()=>{await g(),await h(),k()}),N(()=>{v()}),(s,e)=>{const C=D("router-link");return o(),a("section",q,[t("div",z,[e[3]||(e[3]=t("div",null,[t("h2",{class:"h4 text-light mb-1"},"실시간 자유 채팅방"),t("p",{class:"text-white-50 mb-0"},"0.5초마다 최신 메시지를 불러옵니다.")],-1)),A(C,{class:"btn btn-outline-light nav-hover",to:"/boards"},{default:I(()=>[...e[2]||(e[2]=[B("게시판 보기",-1)])]),_:1})]),_.value?(o(),a("div",Y,"채팅 메시지를 불러오는 중...")):i.value.length?(o(),a("div",J,[(o(!0),a(F,null,P(i.value,l=>(o(),a("article",{key:l.id,class:"chat-message list-group-item"},[t("div",Q,[t("span",{class:K(["fw-semibold",{"text-warning":l.is_anonymous}])},c(l.display_name),3),t("small",null,c(b(l.created_at)),1)]),t("p",W,c(l.content),1)]))),128))])):(o(),a("div",G,"아직 대화가 없습니다. 첫 메시지를 남겨보세요!")),r.value?(o(),a("div",X,c(r.value),1)):V("",!0),E(f)?(o(),a("form",{key:4,class:"chat-form mt-4",autocomplete:"off",onSubmit:H(x,["prevent"])},[t("div",Z,[p(t("input",{id:"chatAnon","onUpdate:modelValue":e[0]||(e[0]=l=>n.is_anonymous=l),class:"form-check-input",type:"checkbox"},null,512),[[R,n.is_anonymous]]),t("label",$,c(n.is_anonymous?"익명으로 보내기":"아이디 공개"),1)]),p(t("textarea",{"onUpdate:modelValue":e[1]||(e[1]=l=>n.content=l),class:"form-control",name:"chat-content",placeholder:"지금 떠오르는 생각을 적어보세요 (최대 500자)",maxlength:"500"},null,512),[[U,n.content]]),t("button",{class:"btn btn-primary nav-hover mt-3",disabled:u.value||!w.value,type:"submit"},[u.value?(o(),a("span",te,"전송 중...")):(o(),a("span",se,"메시지 전송"))],8,ee)],32)):(o(),a("div",ae," 로그인한 사용자만 채팅에 참여할 수 있습니다. 계정 페이지에서 로그인해 주세요. "))])}}};export{re as default};
