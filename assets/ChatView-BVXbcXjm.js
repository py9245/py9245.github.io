import{B as I,u as se,r as c,l as j,K as B,o as ae,L as oe,c as o,a as e,t as d,k as A,F,f as D,q as P,p as v,v as y,x as E,b as le,w as ne,d as ie,e as re,m as O,M as ce,N as de,i as l,n as $,O as H,P as ue,Q as me,R as ve}from"./index-BWrixJQ2.js";const pe={class:"panel"},_e={class:"row g-4"},ye={class:"col-12 col-lg-4"},fe={class:"card border-0 mb-4"},he={class:"card-body"},be={key:0,class:"alert alert-info"},we={key:1,class:"alert alert-danger"},ge={key:2,class:"list-group list-group-flush"},ke={key:0,class:"list-group-item bg-transparent text-white-50"},xe={class:"mb-0 fw-semibold"},Ce={class:"text-white-50"},Re=["disabled","onClick"],Ve={key:0},Le={key:1},Ae={key:2},Se={key:3},Me={key:4},Ne={class:"card border-0 mb-4"},Te={class:"card-body"},Ue={class:"col-12"},Ie={class:"col-12"},je={class:"col-12 form-check form-switch"},Pe={key:0,class:"col-12"},qe={class:"col-12"},Be=["disabled"],Fe={key:0},De={key:1},Ee={class:"card border-0"},Oe={class:"card-body"},$e={class:"col-12"},He={class:"col-12"},Je={class:"col-12"},Ke=["disabled"],ze={key:0},Qe={key:1},Ye={class:"col-12 col-lg-8"},Ge={class:"card border-0 h-100"},We={class:"card-body d-flex flex-column gap-3 h-100"},Xe={class:"d-flex justify-content-between align-items-center"},Ze={class:"text-light mb-1"},et={class:"text-white-50 mb-0"},tt={class:"d-flex gap-2"},st=["disabled"],at={key:0},ot={key:1},lt={key:0,class:"alert alert-info"},nt={key:1,class:"alert alert-secondary"},it={key:2,class:"chat-messages list-group list-group-flush"},rt={class:"d-flex justify-content-between"},ct={class:"mt-1"},dt={key:3,class:"alert alert-warning"},ut={key:4,class:"alert alert-danger"},mt={key:0,class:"form-check form-switch mb-3"},vt={class:"form-check-label text-white-50",for:"chatAnon"},pt={key:1,class:"text-white-50 small"},_t=["disabled"],yt={key:0},ft={key:1},ht={key:6,class:"alert alert-info mt-auto"},bt={key:7,class:"alert alert-warning mt-auto"},J=80,wt=500,Ct={__name:"ChatView",setup(gt){const{profile:f,ensureProfileLoaded:K}=se(),S=I(()=>!!f.value?.user?.is_staff),M=c([]),N=c(!1),w=c(""),n=c(null),g=c(null),k=c(!1),_=c([]),u=j({content:"",is_anonymous:!0}),T=c(!1),x=c(!1),i=c(""),r=j({name:"",capacity:10,is_private:!1,password:""}),C=c(!1),m=j({name:"",password:""}),R=c(!1);let V=null;const z=I(()=>!S.value),Q=s=>{if(!s)return"";const t=typeof s=="string"?new Date(s):s;return Number.isNaN(t.getTime())?"":new Intl.DateTimeFormat("ko-KR",{dateStyle:"short",timeStyle:"short"}).format(t)},Y=I(()=>!!(f.value&&n.value&&u.content.trim())),h=async()=>{N.value=!0,w.value="";try{const s=await ce();M.value=Array.isArray(s?.rooms)?s.rooms:[]}catch(s){console.error(s),w.value="채팅방 목록을 불러오지 못했습니다."}finally{N.value=!1}},L=s=>{n.value=s||null},q=async({roomId:s=n.value?.id,silent:t=!1}={})=>{if(s){t||(T.value=!0,i.value="");try{const p=await ve(s,{limit:J});_.value=Array.isArray(p?.messages)?p.messages:[]}catch(p){console.error(p),i.value=p?.payload?.detail||"채팅 메시지를 불러오지 못했습니다."}finally{t||(T.value=!1)}}},U=()=>{V&&(clearInterval(V),V=null)},G=()=>{U(),n.value&&(V=window.setInterval(()=>{q({roomId:n.value?.id,silent:!0})},wt))};B(S,s=>{s&&(u.is_anonymous=!1)},{immediate:!0}),B(n,s=>{U(),_.value=[],s&&(q({roomId:s.id}),G())});const b=()=>f.value?!0:(i.value="로그인 후 이용해 주세요.",!1),W=async s=>{if(b()){g.value=s.id,i.value="";try{const t=await H({name:s.name});L(t?.room??null),s.is_private||await h()}catch(t){console.error(t),i.value=t?.payload?.detail||"채팅방에 입장하지 못했습니다."}finally{g.value=null}}},X=async()=>{if(b()){if(!m.name.trim()){i.value="비공개 채팅방 이름을 입력해주세요.";return}if(!m.password.trim()){i.value="비공개 채팅방 비밀번호를 입력해주세요.";return}R.value=!0,i.value="";try{const s=await H({name:m.name.trim(),password:m.password});L(s?.room??null),m.name="",m.password=""}catch(s){console.error(s),i.value=s?.payload?.detail||"비공개 채팅방에 입장하지 못했습니다."}finally{R.value=!1}}},Z=async()=>{if(b()){C.value=!0,i.value="";try{const s=await ue({name:r.name.trim(),capacity:Number(r.capacity),is_private:r.is_private,password:r.is_private?r.password:""});if(!s?.room)throw new Error("채팅방 응답이 없습니다.");L(s.room),s.room.is_private||await h(),r.name="",r.password="",r.capacity=10,r.is_private=!1}catch(s){console.error(s),i.value=s?.payload?.detail||(s?.payload&&typeof s.payload=="object"?Object.values(s.payload).flat().join(" "):"채팅방을 생성하지 못했습니다.")}finally{C.value=!1}}},ee=async()=>{if(!(!n.value||!b())){k.value=!0,i.value="";try{await de(n.value.id),L(null),await h()}catch(s){console.error(s),i.value=s?.payload?.detail||"채팅방에서 나가지 못했습니다."}finally{k.value=!1}}},te=async()=>{if(!b())return;if(!n.value){i.value="먼저 채팅방에 입장해 주세요.";return}const s=u.content.trim();if(!s){i.value="메시지를 입력해 주세요.";return}x.value=!0;try{const t=await me(n.value.id,{content:s,is_anonymous:z.value?u.is_anonymous:!1});_.value=[..._.value,t].slice(-J),u.content="",i.value=""}catch(t){console.error(t),i.value=t?.payload?.detail||"메시지를 전송하지 못했습니다."}finally{x.value=!1}};return ae(async()=>{await K(),await h()}),oe(()=>{U()}),(s,t)=>{const p=re("router-link");return l(),o("section",pe,[e("div",_e,[e("div",ye,[e("div",fe,[e("div",he,[t[8]||(t[8]=e("h5",{class:"text-light mb-3"},"공개 채팅방",-1)),t[9]||(t[9]=e("p",{class:"text-white-50 small mb-3"},"목록에는 누구나 입장 가능한 공개형 채팅방만 표시됩니다.",-1)),N.value?(l(),o("div",be,"채팅방 목록을 불러오는 중...")):w.value?(l(),o("div",we,d(w.value),1)):(l(),o("ul",ge,[M.value.length?A("",!0):(l(),o("li",ke," 아직 공개 채팅방이 없습니다. ")),(l(!0),o(F,null,D(M.value,a=>(l(),o("li",{key:a.id,class:"list-group-item d-flex justify-content-between align-items-center bg-transparent text-light"},[e("div",null,[e("p",xe,d(a.name),1),e("small",Ce,d(a.member_count)+"/"+d(a.capacity)+" · "+d(a.owner_username||"운영자"),1)]),e("button",{class:$(["btn btn-sm nav-hover",a.is_member?"btn-secondary":"btn-outline-light"]),disabled:g.value===a.id||a.member_count>=a.capacity||a.is_member&&n.value&&n.value.id===a.id,type:"button",onClick:kt=>W(a)},[g.value===a.id?(l(),o("span",Ve,"입장 중...")):a.is_member&&n.value&&n.value.id===a.id?(l(),o("span",Le,"이용 중")):a.is_member?(l(),o("span",Ae,"입장 완료")):a.member_count>=a.capacity?(l(),o("span",Se,"정원 초과")):(l(),o("span",Me,"입장"))],10,Re)]))),128))])),e("button",{class:"btn btn-outline-info nav-hover mt-3 w-100",type:"button",onClick:h},"새로 고침")])]),e("div",Ne,[e("div",Te,[t[15]||(t[15]=e("h5",{class:"text-light mb-3"},"채팅방 생성",-1)),e("form",{class:"row g-3",autocomplete:"off",onSubmit:P(Z,["prevent"])},[e("div",Ue,[t[10]||(t[10]=e("label",{class:"form-label text-white-50"},"채팅방 이름",-1)),v(e("input",{"onUpdate:modelValue":t[0]||(t[0]=a=>r.name=a),class:"form-control",maxlength:"50",required:""},null,512),[[y,r.name]])]),e("div",Ie,[t[11]||(t[11]=e("label",{class:"form-label text-white-50"},"정원 (2~200명)",-1)),v(e("input",{"onUpdate:modelValue":t[1]||(t[1]=a=>r.capacity=a),class:"form-control",min:"2",max:"200",type:"number",required:""},null,512),[[y,r.capacity,void 0,{number:!0}]])]),e("div",je,[v(e("input",{id:"createPrivate","onUpdate:modelValue":t[2]||(t[2]=a=>r.is_private=a),class:"form-check-input",type:"checkbox"},null,512),[[E,r.is_private]]),t[12]||(t[12]=e("label",{class:"form-check-label text-white-50",for:"createPrivate"},"비공개 채팅방",-1))]),r.is_private?(l(),o("div",Pe,[t[13]||(t[13]=e("label",{class:"form-label text-white-50"},"비밀번호",-1)),v(e("input",{"onUpdate:modelValue":t[3]||(t[3]=a=>r.password=a),class:"form-control",type:"password",minlength:"4",required:""},null,512),[[y,r.password]]),t[14]||(t[14]=e("small",{class:"text-white-50"},"비공개 채팅방은 목록에 표시되지 않으며 비밀번호로만 입장합니다.",-1))])):A("",!0),e("div",qe,[e("button",{class:"btn btn-primary nav-hover w-100",disabled:C.value,type:"submit"},[C.value?(l(),o("span",Fe,"생성 중...")):(l(),o("span",De,"채팅방 생성"))],8,Be)])],32)])]),e("div",Ee,[e("div",Oe,[t[18]||(t[18]=e("h5",{class:"text-light mb-3"},"비공개 채팅방 입장",-1)),e("form",{class:"row g-3",autocomplete:"off",onSubmit:P(X,["prevent"])},[e("div",$e,[t[16]||(t[16]=e("label",{class:"form-label text-white-50"},"채팅방 이름",-1)),v(e("input",{"onUpdate:modelValue":t[4]||(t[4]=a=>m.name=a),class:"form-control",placeholder:"예) 프로젝트 A",required:""},null,512),[[y,m.name]])]),e("div",He,[t[17]||(t[17]=e("label",{class:"form-label text-white-50"},"비밀번호",-1)),v(e("input",{"onUpdate:modelValue":t[5]||(t[5]=a=>m.password=a),class:"form-control",type:"password",required:""},null,512),[[y,m.password]])]),e("div",Je,[e("button",{class:"btn btn-outline-light nav-hover w-100",disabled:R.value,type:"submit"},[R.value?(l(),o("span",ze,"입장 중...")):(l(),o("span",Qe,"입장하기"))],8,Ke)])],32)])])]),e("div",Ye,[e("div",Ge,[e("div",We,[e("div",Xe,[e("div",null,[e("h5",Ze,d(n.value?n.value.name:"채팅방을 선택해 주세요"),1),e("p",et,d(n.value?`정원 ${n.value.member_count}/${n.value.capacity} · ${n.value.is_private?"비공개":"공개"}`:"좌측에서 채팅방을 선택하거나 새로 만들 수 있습니다."),1)]),e("div",tt,[le(p,{class:"btn btn-outline-light btn-sm nav-hover",to:"/boards"},{default:ne(()=>[...t[19]||(t[19]=[ie("게시판 보기",-1)])]),_:1}),n.value?(l(),o("button",{key:0,class:"btn btn-outline-danger btn-sm nav-hover",disabled:k.value,type:"button",onClick:ee},[k.value?(l(),o("span",at,"나가는 중...")):(l(),o("span",ot,"채팅방 나가기"))],8,st)):A("",!0)])]),T.value?(l(),o("div",lt,"채팅 메시지를 불러오는 중...")):n.value&&!_.value.length?(l(),o("div",nt," 아직 대화가 없습니다. 첫 메시지를 남겨보세요! ")):n.value?(l(),o("div",it,[(l(!0),o(F,null,D(_.value,a=>(l(),o("article",{key:a.id,class:"chat-message list-group-item"},[e("div",rt,[e("span",{class:$(["fw-semibold",{"text-warning":a.is_anonymous}])},d(a.display_name),3),e("small",null,d(Q(a.created_at)),1)]),e("p",ct,d(a.content),1)]))),128))])):(l(),o("div",dt,"채팅방을 선택하거나 새로 만들어주세요.")),i.value?(l(),o("div",ut,d(i.value),1)):A("",!0),O(f)&&n.value?(l(),o("form",{key:5,class:"chat-form mt-auto",autocomplete:"off",onSubmit:P(te,["prevent"])},[S.value?(l(),o("p",pt,"관리자는 실명(아이디)으로만 메시지를 보낼 수 있습니다.")):(l(),o("div",mt,[v(e("input",{id:"chatAnon","onUpdate:modelValue":t[6]||(t[6]=a=>u.is_anonymous=a),class:"form-check-input",type:"checkbox"},null,512),[[E,u.is_anonymous]]),e("label",vt,d(u.is_anonymous?"익명으로 보내기":"아이디 공개"),1)])),v(e("textarea",{"onUpdate:modelValue":t[7]||(t[7]=a=>u.content=a),class:"form-control",name:"chat-content",placeholder:"지금 떠오르는 생각을 적어보세요 (최대 500자)",maxlength:"500"},null,512),[[y,u.content]]),e("button",{class:"btn btn-primary nav-hover mt-3",disabled:x.value||!Y.value,type:"submit"},[x.value?(l(),o("span",yt,"전송 중...")):(l(),o("span",ft,"메시지 전송"))],8,_t)],32)):O(f)?(l(),o("div",ht," 채팅방에 입장해야 메시지를 보낼 수 있습니다. ")):(l(),o("div",bt," 로그인한 사용자만 채팅에 참여할 수 있습니다. 계정 페이지에서 로그인해 주세요. "))])])])])])}}};export{Ct as default};
