import{r,l as F,o as j,u as K,c as n,a,k as y,m as M,p as h,v as k,t as c,q as V,F as R,f as W,s as G,i as o,n as H,x as J,y as O,z as Q,A as X}from"./index-CzaoE9JK.js";const Y={class:"panel"},Z={key:0,class:"post-form"},tt={class:"input-group"},et={class:"input-group"},at={class:"post-upload",for:"post-attachment"},lt=["disabled"],st={key:0},nt={key:1},ot={key:1,class:"post-locked"},it={key:2,class:"post-success"},rt={key:3,class:"post-error"},dt={key:4,class:"posts-empty"},ut={key:5,class:"posts-empty"},ct={key:6,class:"posts-list"},pt={class:"post-card__meta"},mt={class:"post-author"},yt={key:0,class:"post-body"},ht=["href"],ft={key:2,class:"post-card__actions"},vt=["onClick"],_t=["disabled","onClick"],bt={key:0},kt={key:1},gt={class:"input-group"},xt={class:"input-group"},At={class:"post-upload",for:"edit-attachment"},wt={class:"chat-toggle"},Ct=["disabled"],St={class:"edit-form__actions"},Pt=["disabled"],Dt={key:0},Bt={key:1},Vt={__name:"BoardsView",setup(Ft){const{profile:g,ensureProfileLoaded:E}=K(),u=r([]),x=r(!0),d=r(""),f=r(""),v=r(!1),i=F({title:"",body:"",attachment:null}),A=r(""),w=r(null),p=r(null),l=F({title:"",body:"",attachment:null,clearAttachment:!1}),C=r(""),S=r(null),_=r(!1),b=r(null),N=e=>{if(!e)return"";const t=typeof e=="string"?new Date(e):e;return Number.isNaN(t.getTime())?"":new Intl.DateTimeFormat("ko-KR",{dateStyle:"long",timeStyle:"short"}).format(t)},z=e=>{const[t]=e.target.files||[];i.attachment=t||null,A.value=t?`${t.name} (${(t.size/(1024*1024)).toFixed(2)}MB)`:""},U=()=>{i.attachment=null,A.value="",w.value&&(w.value.value="")},D=()=>{l.attachment=null,C.value="",S.value&&(S.value.value="")},B=async()=>{x.value=!0;try{const e=await G();u.value=Array.isArray(e?.posts)?e.posts:[]}catch(e){console.error(e),d.value="게시글을 불러오지 못했습니다."}finally{x.value=!1}},$=async()=>{if(d.value="",f.value="",!g.value){d.value="로그인 후 이용해 주세요.";return}if(!i.title.trim()){d.value="제목을 입력해 주세요.";return}v.value=!0;try{const e=new FormData;e.append("title",i.title.trim()),e.append("body",i.body.trim()),i.attachment&&e.append("attachment",i.attachment);const t=await O(e);u.value=[t,...u.value],i.title="",i.body="",U(),f.value="게시글이 등록되었습니다."}catch(e){console.error(e),d.value=e?.payload?.detail||(Array.isArray(e?.payload?.non_field_errors)?e.payload.non_field_errors.join(" "):"게시글을 저장하지 못했습니다.")}finally{v.value=!1}},I=e=>{p.value=e.id,l.title=e.title,l.body=e.body||"",l.clearAttachment=!1,D()},P=()=>{p.value=null,l.title="",l.body="",l.clearAttachment=!1,D()},q=e=>{const[t]=e.target.files||[];l.attachment=t||null,C.value=t?`${t.name} (${(t.size/(1024*1024)).toFixed(2)}MB)`:"",t&&(l.clearAttachment=!1)},L=async()=>{if(p.value){d.value="",_.value=!0;try{const e=new FormData;e.append("title",l.title.trim()),e.append("body",l.body.trim()),l.attachment&&e.append("attachment",l.attachment),l.clearAttachment&&!l.attachment&&e.append("clear_attachment","1");const t=await X(p.value,e);u.value=u.value.map(s=>s.id===t.post.id?t.post:s),P()}catch(e){console.error(e),d.value=e?.payload?.detail||"게시글을 수정하지 못했습니다."}finally{_.value=!1}}},T=async e=>{if(window.confirm("해당 게시글을 삭제하시겠습니까?")){d.value="",b.value=e;try{await Q(e),u.value=u.value.filter(t=>t.id!==e),p.value===e&&P()}catch(t){console.error(t),d.value=t?.payload?.detail||"게시글을 삭제하지 못했습니다."}finally{b.value=null}}};return j(async()=>{await Promise.all([E(),B()])}),(e,t)=>(o(),n("section",Y,[a("header",{class:"panel-header"},[t[5]||(t[5]=a("div",null,[a("h2",null,"파일 첨부 게시판"),a("p",null,"첨부파일은 AWS S3에 저장되며 한 계정당 하루 5개까지 작성 가능합니다.")],-1)),a("button",{class:"ghost-btn",type:"button",onClick:B},"새로 고침")]),M(g)?(o(),n("div",Z,[a("form",{autocomplete:"off",onSubmit:V($,["prevent"])},[a("label",tt,[t[6]||(t[6]=a("span",null,"제목",-1)),h(a("input",{"onUpdate:modelValue":t[0]||(t[0]=s=>i.title=s),placeholder:"게시글 제목",required:""},null,512),[[k,i.title]])]),a("label",et,[t[7]||(t[7]=a("span",null,"내용",-1)),h(a("textarea",{"onUpdate:modelValue":t[1]||(t[1]=s=>i.body=s),rows:"5",placeholder:"전하고 싶은 이야기를 적어보세요"},null,512),[[k,i.body]])]),a("label",at,[t[8]||(t[8]=a("strong",null,"첨부파일",-1)),a("span",null,c(A.value||"최대 5MB, 이미지·문서 업로드 지원"),1)]),a("input",{id:"post-attachment",ref_key:"attachmentInput",ref:w,type:"file",accept:"image/*,application/pdf,application/zip,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.txt",onChange:z},null,544),a("button",{class:"primary-btn",disabled:v.value,type:"submit"},[v.value?(o(),n("span",st,"업로드 중...")):(o(),n("span",nt,"게시글 등록"))],8,lt),t[9]||(t[9]=a("p",{class:"post-hint"},"파일은 최대 5MB, 하루 5개의 게시글 제한이 적용됩니다.",-1))],32)])):(o(),n("div",ot,"로그인한 사용자만 게시글을 작성할 수 있습니다.")),f.value?(o(),n("p",it,c(f.value),1)):y("",!0),d.value?(o(),n("p",rt,c(d.value),1)):y("",!0),x.value?(o(),n("div",dt,"게시글을 불러오는 중...")):u.value.length?(o(),n("div",ct,[(o(!0),n(R,null,W(u.value,s=>(o(),n("article",{key:s.id,class:H(["post-card",{editing:p.value===s.id}])},[a("div",pt,[a("h3",null,c(s.title),1),a("div",null,[a("span",mt,"@"+c(s.author?.username||"알 수 없음"),1),a("time",null,c(N(s.created_at)),1)])]),s.body?(o(),n("p",yt,c(s.body),1)):y("",!0),s.attachment_url?(o(),n("a",{key:1,href:s.attachment_url,class:"post-attachment",target:"_blank",rel:"noreferrer"}," 첨부파일 다운로드 ",8,ht)):y("",!0),M(g)?.user?.id===s.author?.id?(o(),n("div",ft,[a("button",{class:"post-action-btn",type:"button",onClick:m=>I(s)},"수정",8,vt),a("button",{class:"post-action-btn danger",type:"button",disabled:b.value===s.id,onClick:m=>T(s.id)},[b.value===s.id?(o(),n("span",bt,"삭제 중...")):(o(),n("span",kt,"삭제"))],8,_t)])):y("",!0),p.value===s.id?(o(),n("form",{key:3,class:"edit-form",autocomplete:"off",onSubmit:V(L,["prevent"])},[a("label",gt,[t[10]||(t[10]=a("span",null,"제목",-1)),h(a("input",{"onUpdate:modelValue":t[2]||(t[2]=m=>l.title=m),required:""},null,512),[[k,l.title]])]),a("label",xt,[t[11]||(t[11]=a("span",null,"내용",-1)),h(a("textarea",{"onUpdate:modelValue":t[3]||(t[3]=m=>l.body=m),rows:"4"},null,512),[[k,l.body]])]),a("label",At,[t[12]||(t[12]=a("strong",null,"새 첨부파일",-1)),a("span",null,c(C.value||"선택하지 않으면 기존 파일 유지"),1)]),a("input",{id:"edit-attachment",ref_for:!0,ref_key:"editAttachmentInput",ref:S,type:"file",accept:"image/*,application/pdf,application/zip,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.txt",onChange:q},null,544),a("label",wt,[h(a("input",{"onUpdate:modelValue":t[4]||(t[4]=m=>l.clearAttachment=m),type:"checkbox",disabled:!!l.attachment},null,8,Ct),[[J,l.clearAttachment]]),t[13]||(t[13]=a("span",null,"기존 첨부 삭제",-1))]),a("div",St,[a("button",{class:"primary-btn",disabled:_.value,type:"submit"},[_.value?(o(),n("span",Dt,"저장 중...")):(o(),n("span",Bt,"수정 완료"))],8,Pt),a("button",{class:"ghost-btn",type:"button",onClick:P},"수정 취소")])],32)):y("",!0)],2))),128))])):(o(),n("div",ut,"아직 게시글이 없습니다. 첫 글을 남겨보세요!"))]))}};export{Vt as default};
