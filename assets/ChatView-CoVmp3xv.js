import{r as m,l as T,B as M,u as S,o as L,J as N,c as a,a as t,k as V,b as I,w as A,d as B,e as D,F,f as P,t as c,m as E,q as H,p as h,x as R,v as U,K,i as o,n as O,L as q}from"./index-CzaoE9JK.js";const z={class:"panel"},J={class:"panel-header"},Y={key:0,class:"chat-empty"},j={key:1,class:"chat-empty"},G={key:2,class:"chat-messages"},Q={class:"chat-meta"},W={key:3,class:"chat-error"},X={class:"chat-toggle"},Z=["disabled"],$={key:0},ee={key:1},te={key:5,class:"chat-locked"},f=80,se=500,ne={__name:"ChatView",setup(ae){const{profile:p,ensureProfileLoaded:g}=S(),i=m([]),n=T({content:"",is_anonymous:!0}),y=m(!1),u=m(!1),r=m("");let d=null;const k=s=>{if(!s)return"";const e=typeof s=="string"?new Date(s):s;return Number.isNaN(e.getTime())?"":new Intl.DateTimeFormat("ko-KR",{dateStyle:"short",timeStyle:"short"}).format(e)},b=M(()=>!!(p.value&&n.content.trim())),_=async({silent:s=!1}={})=>{s||(y.value=!0,r.value="");try{const e=await K({limit:f});i.value=Array.isArray(e?.messages)?e.messages:[]}catch(e){console.error(e),r.value="채팅 메시지를 불러오지 못했습니다."}finally{s||(y.value=!1)}},v=()=>{d&&(clearInterval(d),d=null)},w=()=>{v(),d=window.setInterval(()=>{_({silent:!0})},se)},x=async()=>{if(!p.value){r.value="로그인 후 이용해 주세요.";return}const s=n.content.trim();if(!s){r.value="메시지를 입력해 주세요.";return}u.value=!0;try{const e=await q({content:s,is_anonymous:n.is_anonymous});i.value=[...i.value,e].slice(-f),n.content="",r.value=""}catch(e){console.error(e),r.value=e?.payload?.detail||"메시지를 전송하지 못했습니다."}finally{u.value=!1}};return L(async()=>{await g(),await _(),w()}),N(()=>{v()}),(s,e)=>{const C=D("router-link");return o(),a("section",z,[t("header",J,[e[3]||(e[3]=t("div",null,[t("h2",null,"실시간 자유 채팅방"),t("p",null,"0.5초마다 최신 메시지를 불러옵니다.")],-1)),I(C,{class:"ghost-btn",to:"/boards"},{default:A(()=>[...e[2]||(e[2]=[B("게시판 보기",-1)])]),_:1})]),y.value?(o(),a("div",Y,"채팅 메시지를 불러오는 중...")):i.value.length?(o(),a("div",G,[(o(!0),a(F,null,P(i.value,l=>(o(),a("article",{key:l.id,class:"chat-message"},[t("div",Q,[t("span",{class:O(["chat-display-name",{anonymous:l.is_anonymous}])},c(l.display_name),3),t("time",null,c(k(l.created_at)),1)]),t("p",null,c(l.content),1)]))),128))])):(o(),a("div",j,"아직 대화가 없습니다. 첫 메시지를 남겨보세요!")),r.value?(o(),a("p",W,c(r.value),1)):V("",!0),E(p)?(o(),a("form",{key:4,class:"chat-form",autocomplete:"off",onSubmit:H(x,["prevent"])},[t("label",X,[h(t("input",{"onUpdate:modelValue":e[0]||(e[0]=l=>n.is_anonymous=l),type:"checkbox"},null,512),[[R,n.is_anonymous]]),t("span",null,c(n.is_anonymous?"익명으로 보내기":"아이디 공개"),1)]),h(t("textarea",{"onUpdate:modelValue":e[1]||(e[1]=l=>n.content=l),name:"chat-content",placeholder:"지금 떠오르는 생각을 적어보세요 (최대 500자)",maxlength:"500"},null,512),[[U,n.content]]),t("button",{class:"primary-btn",disabled:u.value||!b.value,type:"submit"},[u.value?(o(),a("span",$,"전송 중...")):(o(),a("span",ee,"메시지 전송"))],8,Z)],32)):(o(),a("div",te,[...e[4]||(e[4]=[t("p",null,"로그인한 사용자만 채팅에 참여할 수 있습니다. 계정 페이지에서 로그인해 주세요.",-1)])]))])}}};export{ne as default};
